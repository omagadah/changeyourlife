<!DOCTYPE html>
<html lang="fr">
<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Mon Dashboard - Change Your Life</title>
        <link rel="stylesheet" href="/css/main.css">
        <style>
            html, body {
                overflow-x: hidden;
                overflow-y: auto;
            }
            .dashboard-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 2rem 2rem 1rem 2rem;
                background: var(--glass-bg);
                border-bottom: 1px solid var(--glass-border);
            }
            .dashboard-title {
                font-size: 2.2rem;
                font-weight: 700;
                color: var(--accent-color);
            }
            .dashboard-nav {
                display: flex;
                gap: 1.5rem;
            }
            .dashboard-nav a {
                color: var(--text-primary);
                text-decoration: none;
                font-weight: 500;
                font-size: 1.1rem;
                transition: color 0.2s;
            }
            .dashboard-nav a:hover {
                color: var(--accent-color);
            }
            .dashboard-main {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                gap: 2rem;
                padding: 2rem;
            }
            .dashboard-section {
                background: var(--glass-bg);
                border-radius: 16px;
                border: 1px solid var(--glass-border);
                box-shadow: 0 4px 24px rgba(0,0,0,0.08);
                padding: 2rem 1.5rem;
                min-height: 250px;
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
            }
            .section-title {
                font-size: 1.3rem;
                font-weight: 600;
                margin-bottom: 1rem;
                color: var(--accent-color);
            }
            @media (max-width: 700px) {
                .dashboard-header, .dashboard-main {
                    padding: 1rem;
                }
                .dashboard-main {
                    grid-template-columns: 1fr;
                }
            }
        </style>
</head>
<body>
        <header class="dashboard-header">
            <div class="dashboard-title">Mon espace</div>
            <nav class="dashboard-nav">
                <a href="/profile">Profil</a>
                <a href="/settings">Paramètres</a>
                <a href="/">Accueil</a>
            </nav>
            <div class="header">
                <div class="user-panel-trigger" tabindex="0"></div>
                <ul class="user-panel" id="user-panel">
                    <li class="user-panel-item" style="padding: 12px 15px; font-weight: bold; color: var(--accent-color);">
                        <span id="user-email">Utilisateur</span>
                    </li>
                    <li class="user-panel-separator"></li>
                    <li class="user-panel-item"><a href="/profile">Profil</a></li>
                    <li class="user-panel-item"><a href="/settings">Paramètres</a></li>
                    <li class="user-panel-item"><a href="/" >Accueil</a></li>
                    <li class="user-panel-separator"></li>
                    <li class="user-panel-item"><a href="#" id="panel-logout-button">Déconnexion</a></li>
                </ul>
            </div>
        </header>
        <main class="dashboard-main">
                <section class="dashboard-section" id="competences-section">
            <div class="section-title">Compétences</div>
            <form id="competence-form" style="margin-bottom:1rem;display:flex;gap:0.5rem;flex-wrap:wrap;align-items:flex-end;">
                <div style="flex:1;min-width:120px;">
                    <label for="competence-nom" style="font-size:0.95rem;">Nom</label>
                    <input id="competence-nom" type="text" required placeholder="Ex: Scratch, Piano..." style="width:100%;padding:0.5rem;border-radius:6px;border:1px solid var(--glass-border);background:rgba(0,0,0,0.1);color:var(--text-primary);">
                </div>
                <div style="flex:2;min-width:180px;">
                    <label for="competence-description" style="font-size:0.95rem;">Description</label>
                    <input id="competence-description" type="text" required placeholder="Décris ta compétence" style="width:100%;padding:0.5rem;border-radius:6px;border:1px solid var(--glass-border);background:rgba(0,0,0,0.1);color:var(--text-primary);">
                </div>
                <div>
                    <label for="competence-etat" style="font-size:0.95rem;">État</label>
                    <select id="competence-etat" style="padding:0.5rem;border-radius:6px;border:1px solid var(--glass-border);background:rgba(0,0,0,0.1);color:var(--text-primary);">
                        <option value="eveillee">Éveillée</option>
                        <option value="endormie">Endormie</option>
                    </select>
                </div>
                <button type="submit" style="padding:0.7rem 1.2rem;border-radius:8px;background:var(--accent-color);color:white;font-weight:bold;border:none;">Ajouter</button>
            </form>
            <div id="competences-list" style="margin-top:1rem;"></div>
                </section>
                <section class="dashboard-section" id="agenda-section">
                        <div class="section-title">Agenda</div>
                        <p>Synchronisez et visualisez vos événements Google Agenda.</p>
                        <div id="agenda-list">(à venir)</div>
                </section>
                <section class="dashboard-section" id="ia-section">
                        <div class="section-title">Coach IA</div>
                        <p>Discutez avec l’IA pour obtenir des conseils personnalisés.</p>
                        <button id="open-ia-chat" style="margin-top:1rem;">Ouvrir le chat IA</button>
                </section>
                <section class="dashboard-section" id="rappels-section">
                        <div class="section-title">Rappels & Actions</div>
                        <p>Retrouvez ici vos rappels, tâches et actions à venir.</p>
                        <div id="rappels-list">(à venir)</div>
                </section>
        </main>
        <script>
        // Suppression du faux handler logout-link, la déconnexion se fait via le panneau utilisateur (panel-logout-button)
        // Placeholder pour le chat IA
        document.getElementById('open-ia-chat').addEventListener('click', function() {
            alert('Chat IA à venir !');
        });

        // --- Rien ici, tout est déplacé dans le <script type="module"> ci-dessous ---
        </script>
</body>
</html>
        <div class="tools-grid">
            <a href="/app/tool-1" class="tool-card" id="tool-card-1">
                <div class="tool-card-image"></div>
                <h3>Journal Intuitif IA</h3>
                <p>Exprimez vos pensées et recevez des analyses et des conseils personnalisés de notre IA.</p>
            </a>
        </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        // Initialisation unique Firebase (évite les doublons)
        let app, auth, db;
        if (!window._changeyourlifeFirebaseInit) {
            const firebaseConfig = { apiKey: "AIzaSyCvEtaivyC5QD0dGyPKh97IgYU8U8QrrWg", authDomain: "changeyourlife-cc210.firebaseapp.com", projectId: "changeyourlife-cc210", storageBucket: "changeyourlife-cc210.appspot.com", messagingSenderId: "801720080785", appId: "1:801720080785:web:1a74aadba5755ea26c2230" };
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            window._changeyourlifeFirebaseInit = { app, auth, db };
        } else {
            ({ app, auth, db } = window._changeyourlifeFirebaseInit);
        }

        // Gestion du panneau utilisateur et du tutoriel
        const userPanelTrigger = document.querySelector('.user-panel-trigger');
        const userPanel = document.getElementById('user-panel');
        const panelLogoutButton = document.getElementById('panel-logout-button');
        let userId = null;
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('user-email') && (document.getElementById('user-email').textContent = user.email || "Utilisateur Anonyme");
                userPanelTrigger && (userPanelTrigger.textContent = (user.email || 'U').charAt(0).toUpperCase());
                if (document.referrer.includes("/login") || document.referrer.includes("/inscription")) {
                    const toast = document.getElementById('login-toast');
                    if(toast) { toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); }, 4000); }
                }
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);
                if (!userDoc.exists() || userDoc.data().hasSeenTutorial !== true) { startTutorial(userDocRef); }
                // Pour la section compétences :
                userId = user.uid;
                listenCompetences && listenCompetences();
            } else { window.location.href = '/login'; }
        });
        userPanelTrigger && userPanelTrigger.addEventListener('click', (event) => { event.stopPropagation(); userPanel.classList.toggle('active'); });
        window.addEventListener('click', () => { if (userPanel && userPanel.classList.contains('active')) { userPanel.classList.remove('active'); } });
        panelLogoutButton && panelLogoutButton.addEventListener('click', (e) => { e.preventDefault(); signOut(auth).catch(error => console.error("Erreur de déconnexion:", error)); });

        // --- Intégration dynamique compétences ---
        const form = document.getElementById('competence-form');
        const list = document.getElementById('competences-list');
        function listenCompetences() {
            if (!userId) return;
            const competencesRef = collection(db, 'users', userId, 'competences');
            const q = query(competencesRef, orderBy('dateAjout', 'desc'));
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    list.innerHTML = '<em>Aucune compétence pour le moment.</em>';
                } else {
                    list.innerHTML = '';
                    snapshot.forEach(doc => {
                        const c = doc.data();
                        const etatColor = c.etat === 'eveillee' ? 'var(--success-color)' : 'var(--danger-color)';
                        list.innerHTML += `<div style="margin-bottom:0.7rem;padding:0.7rem 1rem;border-radius:8px;background:rgba(0,0,0,0.08);border-left:4px solid ${etatColor};">
                            <strong>${c.nom}</strong> <span style="font-size:0.9em;color:${etatColor};">[${c.etat}]</span><br>
                            <span style="font-size:0.95em;color:var(--text-secondary);">${c.description || ''}</span>
                        </div>`;
                    });
                }
            });
        }

        form && form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) return;
            const nom = document.getElementById('competence-nom').value.trim();
            const description = document.getElementById('competence-description').value.trim();
            const etat = document.getElementById('competence-etat').value;
            if (!nom || !description) return;
            try {
                await addDoc(collection(db, 'users', userId, 'competences'), {
                    nom,
                    description,
                    etat,
                    dateAjout: new Date()
                });
                form.reset();
            } catch (err) {
                alert('Erreur lors de l’ajout : ' + err.message);
            }
        });

        // Tutoriel et effet carte IA
        function startTutorial(userDocRef) {
            const tour = new Shepherd.Tour({ useModalOverlay: true, defaultStepOptions: { classes: 'shepherd-element', scrollTo: { behavior: 'smooth', block: 'center' } } });
            tour.addStep({ title: 'Bienvenue sur votre Espace !', text: "Ceci est votre tableau de bord personnel. C'est ici que vous trouverez tous vos outils pour progresser avec l'ia.", attachTo: { element: '.app-container', on: 'top' }, buttons: [{ action: tour.next, text: 'Suivant &rarr;' }] });
            tour.addStep({ title: 'Votre Menu', text: 'Votre menu personnel se trouve ici. Vous pouvez l\'utiliser pour accéder à vos paramètres ou vous déconnecter.', attachTo: { element: '.user-panel-trigger', on: 'bottom' }, highlightClass: 'shepherd-highlight-user', buttons: [{ action: tour.back, classes: 'shepherd-button-secondary', text: '&larr; Retour' }, { action: tour.next, text: 'Compris !' }] });
            tour.addStep({ title: 'Prêt à commencer ?', text: 'Change Your Life est conçu pour vous aider à voir la vie comme un jeu, avec des quêtes et des succès à débloquer. Explorez, apprenez et grandissez. Votre aventure commence maintenant !', buttons: [{ action: tour.complete, text: 'C\'est parti !' }] });
            const markTutorialAsSeen = () => setDoc(userDocRef, { hasSeenTutorial: true }, { merge: true }).catch(e => console.error("Erreur de mise à jour du tutoriel:", e));
            tour.on('complete', markTutorialAsSeen);
            tour.on('cancel', markTutorialAsSeen);
            tour.start();
        }
        const card = document.getElementById('tool-card-1');
        if (card) {
            card.addEventListener('mousemove', (e) => {
                const rect = card.getBoundingClientRect(); const x = e.clientX - rect.left; const y = e.clientY - rect.top; const centerX = rect.width / 2; const centerY = rect.height / 2; const rotateX = ((y - centerY) / centerY) * -7; const rotateY = ((x - centerX) / centerX) * 7;
                card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.02)`;
            });
            card.addEventListener('mouseleave', () => { card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale(1)'; });
        }
    </script>
</body>
</html>