<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Espace - Change Your Life</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css"/>
        <link rel="stylesheet" href="/css/main.css">
        <style>
            html, body {
                overflow-x: hidden;
                overflow-y: auto;
            }
        </style>
</head>
<body>
    <script>(function() { if (localStorage.getItem('theme') === 'light') document.body.classList.add('light-mode'); })();</script>
    <div id="login-toast" class="toast-notification">
        <div class="toast-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--success-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01" class="checkmark"></polyline>
            </svg>
        </div>
        <span>Connexion réussie !</span>
    </div>
    <header class="header">
        <div class="user-panel-trigger" title="Mon Compte"></div>
        <ul class="user-panel" id="user-panel">
            <li class="user-panel-item"><a href="/profile"><span>Mon Profil</span></a></li>
            <li class="user-panel-item"><a href="/settings"><span>Paramètres</span></a></li>
            <li class="user-panel-separator"></li>
            <li class="user-panel-item"><a href="#" id="panel-logout-button"><span>Se déconnecter</span></a></li>
        </ul>
    </header>
    <main class="app-container">
        <div class="welcome-message">
            <h1>Bienvenue</h1>
            <p>Connecté en tant que : <span id="user-email">Chargement...</span></p>
        </div>
        <div class="tools-grid">
            <a href="/app/tool-1" class="tool-card" id="tool-card-1">
                <div class="tool-card-image"></div>
                <h3>Journal Intuitif IA</h3>
                <p>Exprimez vos pensées et recevez des analyses et des conseils personnalisés de notre IA.</p>
            </a>
        </div>
    </main>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.birds.min.js"></script>
    <script> window.addEventListener('DOMContentLoaded', () => { VANTA.BIRDS({ el: "body", backgroundColor: 0x07192f, color1: 0x4a3a3a, color2: 0xcccccc, quantity: 4.00 }); }); </script>
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = { apiKey: "AIzaSyCvEtaivyC5QD0dGyPKh97IgYU8U8QrrWg", authDomain: "changeyourlife-cc210.firebaseapp.com", projectId: "changeyourlife-cc210", storageBucket: "changeyourlife-cc210.appspot.com", messagingSenderId: "801720080785", appId: "1:801720080785:web:1a74aadba5755ea26c2230" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const userPanelTrigger = document.querySelector('.user-panel-trigger');
        const userPanel = document.getElementById('user-panel');
        const panelLogoutButton = document.getElementById('panel-logout-button');

        function setupUserPanel(auth) {
            userPanelTrigger.addEventListener('click', (event) => { event.stopPropagation(); userPanel.classList.toggle('active'); });
            window.addEventListener('click', () => { if (userPanel.classList.contains('active')) { userPanel.classList.remove('active'); } });
            panelLogoutButton.addEventListener('click', (e) => { e.preventDefault(); auth.signOut().then(() => { localStorage.removeItem('userAvatarUrl'); window.location.href = "/login"; }); });
        }

        function updateGlobalAvatar(initial) {
            const avatarUrl = localStorage.getItem('userAvatarUrl');
            if (avatarUrl) {
                userPanelTrigger.innerHTML = `<img src="${avatarUrl}" alt="User Avatar" style="width:100%; height:100%; border-radius: 50%;">`;
            } else {
                userPanelTrigger.textContent = initial || 'U';
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                setupUserPanel(auth);
                updateGlobalAvatar((user.email || 'U').charAt(0).toUpperCase());

                document.getElementById('user-email').textContent = user.email || "Utilisateur Anonyme";

                if (document.referrer.includes("/login") || document.referrer.includes("/inscription")) {
                    const toast = document.getElementById('login-toast');
                    if(toast) { toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); }, 4000); }
                }

                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);
                if (!userDoc.exists() || userDoc.data().hasSeenTutorial !== true) {
                    startTutorial(userDocRef);
                }
            } else {
                window.location.href = '/login';
            }
        });

        function startTutorial(userDocRef) {
            const tour = new Shepherd.Tour({ useModalOverlay: true, defaultStepOptions: { classes: 'shepherd-element', scrollTo: { behavior: 'smooth', block: 'center' } } });
            tour.addStep({ title: 'Bienvenue sur votre Espace !', text: "Ceci est votre tableau de bord personnel. C'est ici que vous trouverez tous vos outils pour progresser avec l'ia.", attachTo: { element: '.welcome-message', on: 'bottom' }, buttons: [{ action: tour.next, text: 'Suivant →' }] });
            tour.addStep({ title: 'Votre Menu', text: 'Votre menu personnel se trouve ici. Vous pouvez l\'utiliser pour accéder à votre profil ou à vos paramètres.', attachTo: { element: '.user-panel-trigger', on: 'bottom' }, highlightClass: 'shepherd-highlight-user', buttons: [{ action: tour.back, classes: 'shepherd-button-secondary', text: '← Retour' }, { action: tour.next, text: 'Compris !' }] });
            tour.addStep({ title: 'Prêt à commencer ?', text: 'Change Your Life est conçu pour vous aider à voir la vie comme un jeu, avec des quêtes et des succès à débloquer. Explorez, apprenez et grandissez. Votre aventure commence maintenant !', buttons: [{ action: tour.complete, text: 'C\'est parti !' }] });
            const markTutorialAsSeen = () => setDoc(userDocRef, { hasSeenTutorial: true }, { merge: true });
            tour.on('complete', markTutorialAsSeen);
            tour.on('cancel', markTutorialAsSeen);
            tour.start();
        }

        const card = document.getElementById('tool-card-1');
        if (card) {
            card.addEventListener('mousemove', (e) => {
                const rect = card.getBoundingClientRect(); const x = e.clientX - rect.left; const y = e.clientY - rect.top; const centerX = rect.width / 2; const centerY = rect.height / 2; const rotateX = ((y - centerY) / centerY) * -7; const rotateY = ((x - centerX) / centerX) * 7;
                card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.02)`;
            });
            card.addEventListener('mouseleave', () => { card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale(1)'; });
        }
    </script>
</body>
</html>