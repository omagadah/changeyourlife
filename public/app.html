<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Apps - Change Your Life</title>
  <link rel="icon" href="/favicon.svg" />
  <style>
    :root{--bg:#07192f;--glass:rgba(20,20,20,0.65);--accent:#00aaff;--text:#e6eef5}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    .header{position:fixed;top:14px;right:18px;z-index:100}
    .user-panel-trigger{width:44px;height:44px;border-radius:8px;display:flex;align-items:center;justify-content:center;border:none;background:transparent;padding:0;cursor:pointer}
    .app-wrap{position:absolute;inset:18px;background:var(--glass);border-radius:16px;padding:24px;box-shadow:0 8px 30px rgba(0,0,0,.4);overflow:auto}
    h1{margin:0 0 18px 0}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px}
    .tile{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);padding:16px;border-radius:12px;min-height:160px;display:flex;flex-direction:column}
    .tile h3{margin:0 0 8px 0}
    .tile p{margin:0 0 12px 0;color:#b8c6d0}
    .tile .actions{margin-top:auto;display:flex;gap:8px}
    .btn{background:var(--accent);color:#012; padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    iframe.appframe{width:100%;height:520px;border:0;border-radius:8px;background:white}
    .hint{color:#9fb6c8;font-size:0.92rem}
  </style>
</head>
<body>
  <header class="header">
    <button class="user-panel-trigger" aria-label="Ouvrir le menu"><img src="/logo.svg" alt="logo" style="width:40px;height:40px;display:block;border-radius:6px;"/></button>
  </header>

  <main class="app-wrap">
    <h1>Apps</h1>
    <p class="hint">Cliquez sur une app pour l'ouvrir. Certaines applications peuvent bloquer l'intégration (Content-Security-Policy). Si l'iframe ne s'affiche pas, utilisez "Ouvrir".</p>

    <div class="grid">
      <div class="tile" id="v0-agent">
        <h3>AI Agent Builder (v0.app)</h3>
        <p>Flow designer pour agents — intégré depuis https://v0.app</p>
        <div class="actions">
          <button class="btn" id="open-v0">Ouvrir</button>
          <button class="btn" id="embed-v0" style="background:#0b8;">Intégrer</button>
        </div>
        <div id="v0-container" style="margin-top:12px"></div>
      </div>

      <!-- placeholder for more app tiles -->
    </div>
  </main>

  <script type="module">
    import { initUserMenu } from '/js/userMenu.js';
    // show menu on header trigger click
    document.querySelectorAll('.user-panel-trigger').forEach(btn => btn.addEventListener('click', (e)=>{ e.stopPropagation(); initUserMenu(); const menu=document.getElementById('cyf-user-menu'); if(menu){ menu.style.display = (menu.style.display==='block')? 'none':'block'; }}));

    // Auth guard - reuse singleton
    (async function initAuth(){
      try{
        const authModule = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');
        const { getAuth } = authModule;
        if(window._cyfFirebase){ return; }
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js');
        const firebaseConfig = { apiKey: "AIzaSyCvEtaivyC5QD0dGyPKh97IgYU8U8QrrWg", authDomain: "changeyourlife-cc210.firebaseapp.com", projectId: "changeyourlife-cc210", storageBucket: "changeyourlife-cc210.appspot.com", messagingSenderId: "801720080785", appId: "1:801720080785:web:1a74aadba5755ea26c2230" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        window._cyfFirebase = { app, auth };
      }catch(e){ console.error('auth init failed', e); }
    })();

    const v0Url = 'https://v0.app/chat/ai-agent-builder-roAX5JAUfYt';
    const openBtn = document.getElementById('open-v0');
    const embedBtn = document.getElementById('embed-v0');
    const container = document.getElementById('v0-container');

    openBtn.addEventListener('click', ()=> window.open(v0Url, '_blank'));

    embedBtn.addEventListener('click', async ()=>{
      container.innerHTML = '';
      const iframe = document.createElement('iframe');
      iframe.className = 'appframe';
      iframe.src = v0Url;
      iframe.sandbox = 'allow-scripts allow-forms allow-same-origin allow-modals';
      container.appendChild(iframe);

      // If the iframe failed to load due to CSP, show fallback link
      setTimeout(()=>{
        try{
          // try access same-origin property as a simple probe
          const accessible = (iframe.contentWindow && iframe.contentDocument);
          // if not accessible (cross-origin) we still allow it, but if CSP prevented framing it may be blank
        }catch(e){ /* cross origin - expected */ }
      },1200);
    });
  </script>
</body>
</html>