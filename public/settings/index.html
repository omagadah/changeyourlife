<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <!-- Deploy test: V√©rification connexion Vercel - 2025-11-12T10:00:00Z | Ce commentaire sert √† d√©clencher un build -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard & Param√®tres - Change Your Life</title>
    <link rel="stylesheet" href="/css/main.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #0a0e27 0%, #111827 100%); color: #f9fafb; min-height: 100vh; }
        #vanta-birds-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        .dashboard-container { position: relative; z-index: 1; display: flex; height: 100vh; }
        .sidebar { width: 280px; background: rgba(31, 41, 55, 0.8); backdrop-filter: blur(10px); border-right: 1px solid rgba(255, 255, 255, 0.1); display: flex; flex-direction: column; padding: 24px 16px; }
        .logo-section { display: flex; align-items: center; gap: 12px; padding: 12px; margin-bottom: 32px; }
        .logo-section svg { width: 40px; height: 40px; }
        .logo-section h1 { font-size: 1.25rem; font-weight: 700; background: linear-gradient(135deg, #3b82f6, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .nav-menu { flex: 1; overflow-y: auto; }
        .nav-section { margin-bottom: 24px; }
        .nav-section-title { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: #9ca3af; padding: 8px 12px; margin-bottom: 8px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; color: #9ca3af; cursor: pointer; transition: all 0.2s; margin-bottom: 4px; }
        .nav-item:hover { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
        .nav-item.active { background: #3b82f6; color: white; }
        .nav-item svg { width: 20px; height: 20px; }
        .main-content { flex: 1; overflow-y: auto; padding: 32px; }
        .content-header { margin-bottom: 32px; }
        .content-header h2 { font-size: 2rem; font-weight: 700; margin-bottom: 8px; }
        .content-header p { color: #9ca3af; font-size: 1rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-bottom: 32px; }
        .stat-card { background: rgba(31, 41, 55, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 24px; transition: transform 0.2s, box-shadow 0.2s; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); }
        .stat-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .stat-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .stat-icon.blue { background: rgba(59, 130, 246, 0.2); }
        .stat-icon.purple { background: rgba(139, 92, 246, 0.2); }
        .stat-icon.green { background: rgba(16, 185, 129, 0.2); }
        .stat-icon.orange { background: rgba(245, 158, 11, 0.2); }
        .stat-trend { font-size: 0.875rem; padding: 4px 12px; border-radius: 20px; font-weight: 600; }
        .stat-trend.up { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .stat-trend.down { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .stat-value { font-size: 2.5rem; font-weight: 700; margin-bottom: 4px; }
        .stat-label { color: #9ca3af; font-size: 0.875rem; }
        .chart-card { background: rgba(31, 41, 55, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 24px; margin-bottom: 32px; max-width: 700px; height: 350px; }
        .chart-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
        .chart-title { font-size: 1.25rem; font-weight: 600; }
        .chart-filters { display: flex; gap: 8px; }
        .filter-btn { padding: 8px 16px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1); background: transparent; color: #9ca3af; cursor: pointer; transition: all 0.2s; }
        .filter-btn:hover { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
        .filter-btn.active { background: #3b82f6; color: white; border-color: #3b82f6; }
        .settings-section { display: none; }
        .settings-section.active { display: block; }
        .settings-group { background: rgba(31, 41, 55, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 24px; margin-bottom: 24px; }
        .settings-group-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 16px; }
        .setting-item { display: flex; align-items: center; justify-content: space-between; padding: 16px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .setting-item:last-child { border-bottom: none; }
        .setting-info h4 { font-size: 1rem; margin-bottom: 4px; }
        .setting-info p { font-size: 0.875rem; color: #9ca3af; }
        .toggle-switch { position: relative; width: 52px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; inset: 0; background: #374151; border-radius: 28px; transition: 0.3s; }
        .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background: white; border-radius: 50%; transition: 0.3s; }
        input:checked + .toggle-slider { background: #3b82f6; }
        input:checked + .toggle-slider:before { transform: translateX(24px); }
        .btn { padding: 12px 24px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; transform: translateY(-2px); }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-secondary { background: rgba(255, 255, 255, 0.1); color: #f9fafb; }
        .input-group { margin-bottom: 20px; }
        .input-label { display: block; margin-bottom: 8px; color: #9ca3af; font-size: 0.875rem; }
        .input-field { width: 100%; padding: 12px; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #f9fafb; font-size: 1rem; }
        .input-field:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .danger-zone { background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; border-radius: 16px; padding: 24px; }
        .danger-zone h3 { color: #ef4444; margin-bottom: 12px; }
        .header-logo { position: fixed; top: 20px; right: 30px; z-index: 200; background: none; border: none; cursor: pointer; padding: 0; }
        .note { padding: 12px 16px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #9ca3af; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; }
        .hint-card { margin: 8px 0 20px; padding: 10px 14px; border-radius: 10px; background: rgba(59,130,246,0.08); border: 1px dashed rgba(59,130,246,0.35); color: #cfe3ff; font-size: 0.95rem; font-family: Georgia, "Times New Roman", serif; }
        .hint-card a { color: #a6c8ff; text-decoration: underline; }
    </style>
</head>
<body>
<div id="vanta-birds-bg"></div>
<button class="header-logo user-panel-trigger" title="Mon Compte" aria-label="Ouvrir le menu">
<svg data-cyf-logo="1" viewBox="0 0 200 120" xmlns="http://www.w3.org/2000/svg" width="40" height="40">
<g stroke-width="3"><circle cx="60" cy="60" r="40" fill="black" stroke="#3399ff" stroke-width="8"/><line x1="100" y1="60" x2="130" y2="30" stroke="white"/><line x1="100" y1="60" x2="130" y2="60" stroke="white"/><line x1="100" y1="60" x2="130" y2="90" stroke="white"/><circle cx="150" cy="30" r="18" fill="none" stroke="white"/><circle cx="150" cy="60" r="18" fill="none" stroke="white"/><circle cx="150" cy="90" r="18" fill="none" stroke="white"/></g>
</svg>
</button>
<div class="dashboard-container">
<aside class="sidebar">
<div class="logo-section">
<svg viewBox="0 0 200 120" xmlns="http://www.w3.org/2000/svg"><circle cx="60" cy="60" r="40" fill="black" stroke="#3399ff" stroke-width="8"/></svg>
<h1>ChangeYourLife.ai</h1>
</div>
<nav class="nav-menu">
<div class="nav-section">
<div class="nav-section-title">Dashboard</div>
<div class="nav-item active" data-section="dashboard">
<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
<span>Vue d'ensemble</span>
</div>
</div>
<div class="nav-section">
<div class="nav-section-title">Param√®tres</div>
<div class="nav-item" data-section="preferences">
<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
<span>Pr√©f√©rences</span>
</div>
<div class="nav-item" data-section="security">
<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
<span>S√©curit√©</span>
</div>
</div>
<div class="nav-section" id="admin-nav-section" style="display: none;">
<div class="nav-section-title">Administration</div>
<div class="nav-item" data-section="admin">
<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
<span>Panel Admin</span>
</div>
</div>
</nav>
</aside>
<main class="main-content">
<section id="dashboard" class="settings-section active">
<div class="content-header">
<h2>Dashboard ChangeYourLife.ai</h2>
<p>Vue d'ensemble de votre progression et bien-√™tre</p>
</div>
<div class="stats-grid">
<div class="stat-card"><div class="stat-header"><div class="stat-icon blue"></div><div class="stat-trend up"> 0%</div></div><div class="stat-value" id="stat-humeur">0</div><div class="stat-label">Humeur moyenne</div></div>
<div class="stat-card"><div class="stat-header"><div class="stat-icon purple"></div><div class="stat-trend up"> 0</div></div><div class="stat-value" id="stat-habitudes">0</div><div class="stat-label">Habitudes tenues</div></div>
<div class="stat-card"><div class="stat-header"><div class="stat-icon green"></div><div class="stat-trend down"> 0%</div></div><div class="stat-value" id="stat-focus">0</div><div class="stat-label">Minutes de focus</div></div>
<div class="stat-card"><div class="stat-header"><div class="stat-icon orange"></div><div class="stat-trend up"> 0</div></div><div class="stat-value" id="stat-journal">0</div><div class="stat-label">Entr√©es journal</div></div>
</div>
<div class="chart-card">
<div class="chart-header">
<h3 class="chart-title" id="chart-title">√âvolution ChangeYourLife.ai (7 derniers jours)</h3>
<div class="chart-filters">
<button class="filter-btn active">7J</button>
<button class="filter-btn">30J</button>
<button class="filter-btn">3M</button>
</div>
</div>
<canvas id="monkyChart" width="650" height="300" style="display:block;max-width:100%;height:300px;"></canvas>
</div>
</section>
<section id="preferences" class="settings-section">
<div class="content-header"><h2>Pr√©f√©rences</h2><p>Personnalisez votre exp√©rience</p></div>
<div class="hint-card">
    Pour g√©rer votre avatar, votre nom public et votre titre, rendez-vous dans <a href="/profile">Mon Profil</a>. Ici, vous ne trouverez que les pr√©f√©rences d‚Äôaffichage et de notifications.
 </div>
<div class="settings-group">
<h3 class="settings-group-title">Apparence</h3>
<div class="setting-item"><div class="setting-info"><h4>Th√®me sombre</h4><p>Activer le mode sombre pour r√©duire la fatigue oculaire</p></div><label class="toggle-switch"><input type="checkbox" id="dark-theme" checked><span class="toggle-slider"></span></label></div>
<div class="setting-item"><div class="setting-info"><h4>Animations</h4><p>Activer les animations de l'interface</p></div><label class="toggle-switch"><input type="checkbox" id="animations" checked><span class="toggle-slider"></span></label></div>
</div>
<div class="settings-group">
<h3 class="settings-group-title">Notifications</h3>
<div class="setting-item"><div class="setting-info"><h4>Rappels quotidiens</h4><p>Recevoir des rappels pour vos habitudes</p></div><label class="toggle-switch"><input type="checkbox" id="daily-reminders"><span class="toggle-slider"></span></label></div>
<div class="setting-item"><div class="setting-info"><h4>Notifications par email</h4><p>Recevoir des r√©sum√©s hebdomadaires par email</p></div><label class="toggle-switch"><input type="checkbox" id="email-notifications"><span class="toggle-slider"></span></label></div>
</div>
</section>
<section id="security" class="settings-section">
<div class="content-header"><h2>S√©curit√©</h2><p>Prot√©gez votre compte</p></div>
<div id="security-sso-info" class="settings-group" style="display:none;">
    <h3 class="settings-group-title">Authentification via un fournisseur</h3>
    <div class="note">Vous √™tes connect√© via Google ou GitHub. Pour modifier votre email ou votre mot de passe, rendez-vous dans les param√®tres de votre compte Google ou GitHub. Ces changements ne peuvent pas √™tre effectu√©s depuis ChangeYourLife.ai.</div>
    <div style="margin-top:12px;" class="note">Vous pouvez toujours g√©rer votre profil (avatar, nom public, th√®me) depuis <a href="/profile" style="color:#3b82f6;">Mon Profil</a>.</div>
    <div id="security-sso-provider" style="margin-top:8px;color:#9ca3af;font-size:0.9rem;"></div>
    </div>

<div id="security-cred-section" class="settings-group" style="display:none;">
    <h3 class="settings-group-title">Identifiants du compte</h3>
    <div class="grid-2">
        <div>
            <h4 style="margin-bottom:8px;">Changer d'email</h4>
            <div class="input-group">
                <label class="input-label" for="new-email">Nouvel email</label>
                <input type="email" id="new-email" class="input-field" placeholder="exemple@domaine.com">
            </div>
            <div class="input-group">
                <label class="input-label" for="current-password-email">Mot de passe actuel (pour v√©rification)</label>
                <input type="password" id="current-password-email" class="input-field" placeholder="Votre mot de passe">
            </div>
            <button class="btn btn-primary" id="update-email-btn">Mettre √† jour l'email</button>
        </div>
        <div>
            <h4 style="margin-bottom:8px;">Changer le mot de passe</h4>
            <div class="input-group">
                <label class="input-label" for="current-password">Mot de passe actuel</label>
                <input type="password" id="current-password" class="input-field" placeholder="Mot de passe actuel">
            </div>
            <div class="input-group">
                <label class="input-label" for="new-password">Nouveau mot de passe</label>
                <input type="password" id="new-password" class="input-field" placeholder="Nouveau mot de passe">
            </div>
            <div class="input-group">
                <label class="input-label" for="confirm-password">Confirmer le nouveau mot de passe</label>
                <input type="password" id="confirm-password" class="input-field" placeholder="Confirmer le mot de passe">
            </div>
            <button class="btn btn-secondary" id="update-password-btn">Mettre √† jour le mot de passe</button>
        </div>
    </div>
    <div id="security-feedback" style="margin-top:16px;display:none;padding:12px;border-radius:8px;"></div>
</div>
<div class="danger-zone">
<h3>Zone de danger</h3>
<p style="margin-bottom: 16px; color: #9ca3af;">La suppression de votre compte est d√©finitive et irr√©versible. Toutes vos donn√©es seront perdues.</p>
<button class="btn btn-danger" id="delete-account-btn">Supprimer mon compte</button>
</div>
</section>
<section id="admin" class="settings-section">
<div class="content-header">
    <h2>Panel Administrateur</h2>
    <p>Outils r√©serv√©s aux administrateurs</p>
    <div id="admin-user-info" style="margin-top:12px;padding:12px;background:rgba(59,130,246,0.1);border-radius:8px;border:1px solid rgba(59,130,246,0.3);color:#3b82f6;font-weight:600;font-size:0.95rem;display:none;">
        <span id="admin-email"></span>
        <br>
        <span style="font-size:0.8rem;color:#9ca3af;font-weight:400;">UID: <code id="admin-uid-display" style="background:rgba(0,0,0,0.3);padding:2px 8px;border-radius:4px;"></code></span>
    </div>
</div>
<div class="settings-group">
    <h3 class="settings-group-title">Outils Admin</h3>
    <div class="input-group">
        <label class="input-label">UID Utilisateur</label>
        <input type="text" class="input-field" placeholder="Entrez l'UID d'un utilisateur..." id="admin-uid">
    </div>
    <button class="btn btn-primary" id="download-user-data-btn">T√©l√©charger les donn√©es</button>
    <div id="admin-feedback" style="margin-top:16px;padding:12px;border-radius:8px;font-weight:500;display:none;"></div>
</div>
<div class="settings-group">
    <h3 class="settings-group-title">Exports & Filtres</h3>
    <div class="grid-2">
        <div>
            <div class="input-group">
                <label class="input-label">P√©riode d'activit√©</label>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn btn-secondary" data-admin-range="7">7J</button>
                    <button class="btn btn-secondary" data-admin-range="30">30J</button>
                    <button class="btn btn-secondary" data-admin-range="90">90J</button>
                </div>
            </div>
            <div class="note">La p√©riode affecte le calcul des utilisateurs actifs et l'export CSV ci-contre.</div>
        </div>
        <div>
            <div class="input-group">
                <label class="input-label">Export CSV (utilisateurs actifs sur la p√©riode)</label>
                <button class="btn btn-primary" id="export-csv-btn">Exporter CSV</button>
            </div>
            <div class="note">Champs export√©s: uid, email, displayName, lastActive, niveaux (body/etre/heart/order), nbBadges.</div>
        </div>
    </div>
</div>
<div class="settings-group">
    <h3 class="settings-group-title">Gestion des utilisateurs</h3>
    <div class="input-group">
        <label class="input-label">Rechercher un utilisateur</label>
        <input type="text" class="input-field" placeholder="Email ou nom..." id="search-user">
    </div>
    <button class="btn btn-secondary" id="search-user-btn">Rechercher</button>
    <div id="admin-search-results" style="margin-top:12px;color:#9ca3af;font-size:0.9rem;"></div>
</div>
<div class="settings-group">
    <h3 class="settings-group-title">Statistiques Admin</h3>
    <div class="stats-grid" style="margin-top:16px;">
    <div class="stat-card"><div class="stat-header"><div class="stat-icon blue"></div></div><div class="stat-value" id="admin-users">0</div><div class="stat-label">Utilisateurs inscrits</div></div>
    <div class="stat-card"><div class="stat-header"><div class="stat-icon green"></div></div><div class="stat-value" id="admin-active">0</div><div class="stat-label">Utilisateurs actifs</div></div>
    </div>
</div>
<div class="settings-group">
    <h3 class="settings-group-title">R√¥les & Mod√©ration</h3>
    <div class="note" style="margin-bottom:10px;">Ajoutez/retirez des mod√©rateurs via leur UID.</div>
    <div class="grid-2">
        <div>
            <div class="input-group">
                <label class="input-label">UID Utilisateur</label>
                <input type="text" class="input-field" placeholder="UID..." id="mod-uid">
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn btn-primary" id="add-mod-btn">Ajouter Mod√©rateur</button>
                <button class="btn btn-secondary" id="remove-mod-btn">Retirer Mod√©rateur</button>
            </div>
        </div>
        <div>
            <div class="note">R√¥les stock√©s dans Firestore: <code>roles/{uid}</code> avec <code>mod: true</code>. Les admins sont g√©r√©s via la constante <code>ADMIN_UIDS</code> c√¥t√© client pour l‚Äôinstant.</div>
        </div>
    </div>
    <div id="admin-roles-feedback" style="margin-top:12px;padding:10px;border-radius:8px;display:none;"></div>
</div>
</section>
</main>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.birds.min.js"></script>
<script type="module">
import { getAuth, onAuthStateChanged, updateEmail, updatePassword, EmailAuthProvider, reauthenticateWithCredential, deleteUser, reauthenticateWithPopup, GoogleAuthProvider, GithubAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, query, where, limit, getDocs, getCountFromServer, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { updateGlobalAvatar } from "/js/common.js";
import { initUserMenu } from "/js/userMenu.js";

const firebaseConfig = {
    apiKey: "AIzaSyCvEtaivyC5QD0dGyPKh97IgYU8U8QrrWg",
    authDomain: "changeyourlife-cc210.firebaseapp.com",
    projectId: "changeyourlife-cc210",
    storageBucket: "changeyourlife-cc210.appspot.com",
    messagingSenderId: "801720080785",
    appId: "1:801720080785:web:1a74aadba5755ea26c2230"
};

let auth, db;

// Liste des UIDs admin - AJOUTEZ ICI LES UIDs DES ADMINS
const ADMIN_UIDS = ["PvDinfGc2hRribdPE4JW9Bv5Ip42"]; // Ajoute l'UID de romainruiz31@gmail.com ici

// Affiche les informations de l'utilisateur admin
function showAdminInfo(user) {
    const infoDiv = document.getElementById('admin-user-info');
    const emailSpan = document.getElementById('admin-email');
    const uidSpan = document.getElementById('admin-uid-display');
    
    if (infoDiv && user) {
        emailSpan.textContent = `Connect√© en tant qu'admin : ${user.email || 'Utilisateur inconnu'}`;
        uidSpan.textContent = user.uid;
        infoDiv.style.display = 'block';
        
        // Log l'UID dans la console pour faciliter la configuration
        console.log(`%cüîß ADMIN UID: ${user.uid}`, 'background: #3b82f6; color: white; padding: 8px; border-radius: 4px; font-weight: bold;');
        console.log(`%cüìß ADMIN EMAIL: ${user.email}`, 'background: #10b981; color: white; padding: 8px; border-radius: 4px;');
    }
}

// Feedback visuel pour les actions admin
function showAdminFeedback(message, success = true) {
    const feedbackDiv = document.getElementById('admin-feedback');
    if (feedbackDiv) {
        feedbackDiv.textContent = message;
        feedbackDiv.style.backgroundColor = success ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';
        feedbackDiv.style.color = success ? '#10b981' : '#ef4444';
        feedbackDiv.style.border = success ? '1px solid rgba(16, 185, 129, 0.3)' : '1px solid rgba(239, 68, 68, 0.3)';
        feedbackDiv.style.display = 'block';
        setTimeout(() => { feedbackDiv.style.display = 'none'; }, 3500);
    }
}

// Initialisation de l'authentification
function initAuth() {
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            initUserMenu();
            updateGlobalAvatar((user.email || "U").charAt(0).toUpperCase());
            
            // V√©rifie si l'utilisateur est admin
            let isAdmin = ADMIN_UIDS.includes(user.uid);
            let isMod = false;
            if (!isAdmin) {
                try { const r = await getDoc(doc(db, 'roles', user.uid)); isMod = !!(r.exists() && r.data().mod === true); } catch(e) {}
            }
            if (isAdmin || isMod) {
                document.getElementById("admin-nav-section").style.display = "block";
                showAdminInfo(user);
            }
            
            // Affiche/masque les options de s√©curit√© selon le fournisseur d'identit√©
            try {
                const providers = (user.providerData || []).map(p => p.providerId);
                const isPasswordUser = providers.includes('password');
                const ssoInfo = document.getElementById('security-sso-info');
                const credSection = document.getElementById('security-cred-section');
                const provEl = document.getElementById('security-sso-provider');
                if (isPasswordUser) {
                    if (credSection) credSection.style.display = 'block';
                    if (ssoInfo) ssoInfo.style.display = 'none';
                } else {
                    if (credSection) credSection.style.display = 'none';
                    if (ssoInfo) ssoInfo.style.display = 'block';
                    if (provEl) provEl.textContent = `Fournisseur d√©tect√©: ${providers.join(', ') || 'inconnu'}`;
                }
            } catch(e) { console.warn('Provider check failed', e); }
            // Stats: marquer l'activit√©
            try { await setDoc(doc(db, 'users', user.uid), { lastActive: serverTimestamp(), email: user.email || null }, { merge: true }); } catch(e) {}

            // Charger les pr√©f√©rences depuis Firestore et brancher les toggles
            initSettingsToggles(user.uid);

            initChart();
            initNavigation();

            // Initialiser les features admin
            if (isAdmin || isMod) {
                try { await updateAdminStats(); } catch(e) {}
                bindAdminHandlers();
            }
        } else {
            if (!["127.0.0.1", "localhost"].includes(location.hostname)) {
                window.location.href = "/login";
                return;
            }
            initChart();
            initNavigation();
        }
    });
}

// Navigation entre les sections
function initNavigation() {
    document.querySelectorAll(".nav-item").forEach(item => {
        item.addEventListener("click", () => {
            const section = item.getAttribute("data-section");
            document.querySelectorAll(".nav-item").forEach(i => i.classList.remove("active"));
            item.classList.add("active");
            document.querySelectorAll(".settings-section").forEach(s => s.classList.remove("active"));
            document.getElementById(section)?.classList.add("active");
        });
    });
}

// Initialisation du graphique Chart.js
// Chart period data (all zero for now, ready for future dynamic stats)
const chartDataSets = {
    '7J': {
        labels: ["Lun", "Mar", "Mer", "Jeu", "Ven", "Sam", "Dim"],
        data: [0, 0, 0, 0, 0, 0, 0]
    },
    '30J': {
        labels: Array.from({length: 30}, (_, i) => `J${i+1}`),
        data: Array(30).fill(0)
    },
    '3M': {
        labels: ["Jan", "F√©v", "Mar"],
        data: [0, 0, 0]
    }
};
let chartInstance = null;
function initChart() {
    const canvas = document.getElementById("monkyChart");
    if (!canvas || !window.Chart) return;
    const ctx = canvas.getContext("2d");
    const defaultPeriod = '7J';
    const titleEl = document.getElementById('chart-title');
    const titleByPeriod = {
        '7J': '7 derniers jours',
        '30J': '30 derniers jours',
        '3M': '3 derniers mois'
    };
    function updateTitle(period) {
        if (!titleEl) return;
        const suffix = titleByPeriod[period] || '7 derniers jours';
        titleEl.textContent = `√âvolution ChangeYourLife.ai (${suffix})`;
    }
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
        type: "line",
        data: {
            labels: chartDataSets[defaultPeriod].labels,
            datasets: [{
                label: "Score ChangeYourLife.ai",
                data: chartDataSets[defaultPeriod].data,
                borderColor: "#3b82f6",
                backgroundColor: "rgba(59, 130, 246, 0.1)",
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: "#3b82f6",
                pointBorderColor: "#fff",
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: "rgba(31, 41, 55, 0.9)",
                    padding: 12,
                    borderColor: "rgba(255, 255, 255, 0.1)",
                    borderWidth: 1
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    min: 0,
                    max: 10,
                    ticks: { color: "#9ca3af" },
                    grid: { color: "rgba(255, 255, 255, 0.05)" }
                },
                x: {
                    ticks: { color: "#9ca3af" },
                    grid: { color: "rgba(255, 255, 255, 0.05)" }
                }
            }
        }
    });
    // Set correct initial title
    updateTitle(defaultPeriod);
    // Chart period filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const period = btn.textContent.trim();
            if (chartInstance && chartDataSets[period]) {
                chartInstance.data.labels = chartDataSets[period].labels;
                chartInstance.data.datasets[0].data = chartDataSets[period].data;
                chartInstance.update();
            }
            updateTitle(period);
        });
    });
}

// Gestion des actions S√©curit√© (email / mot de passe)
function setSecurityFeedback(msg, ok = true) {
    const el = document.getElementById('security-feedback');
    if (!el) return;
    el.textContent = msg;
    el.style.display = 'block';
    el.style.background = ok ? 'rgba(16,185,129,0.12)' : 'rgba(239,68,68,0.12)';
    el.style.border = ok ? '1px solid rgba(16,185,129,0.35)' : '1px solid rgba(239,68,68,0.35)';
    el.style.color = ok ? '#10b981' : '#ef4444';
    setTimeout(() => { el.style.display = 'none'; }, 4000);
}

document.addEventListener('DOMContentLoaded', () => {
    const emailBtn = document.getElementById('update-email-btn');
    const pwdBtn = document.getElementById('update-password-btn');
    if (emailBtn) {
        emailBtn.addEventListener('click', async () => {
            const user = auth && auth.currentUser;
            if (!user) return;
            const newEmail = (document.getElementById('new-email') || {}).value?.trim();
            const currentPwd = (document.getElementById('current-password-email') || {}).value;
            if (!newEmail) { setSecurityFeedback("Veuillez entrer un nouvel email", false); return; }
            try {
                if (currentPwd) {
                    const cred = EmailAuthProvider.credential(user.email, currentPwd);
                    await reauthenticateWithCredential(user, cred);
                }
                await updateEmail(user, newEmail);
                setSecurityFeedback("Email mis √† jour avec succ√®s.");
            } catch (e) {
                console.error(e);
                if (e?.code === 'auth/requires-recent-login') {
                    setSecurityFeedback("Action sensible: veuillez vous reconnecter puis r√©essayer.", false);
                } else if (e?.code === 'auth/email-already-in-use') {
                    setSecurityFeedback("Cet email est d√©j√† utilis√©.", false);
                } else {
                    setSecurityFeedback("√âchec de la mise √† jour de l'email.", false);
                }
            }
        });
    }
    if (pwdBtn) {
        pwdBtn.addEventListener('click', async () => {
            const user = auth && auth.currentUser;
            if (!user) return;
            const currentPwd = (document.getElementById('current-password') || {}).value;
            const newPwd = (document.getElementById('new-password') || {}).value;
            const confirm = (document.getElementById('confirm-password') || {}).value;
            if (!newPwd || newPwd.length < 6) { setSecurityFeedback("Le nouveau mot de passe doit contenir au moins 6 caract√®res.", false); return; }
            if (newPwd !== confirm) { setSecurityFeedback("Les mots de passe ne correspondent pas.", false); return; }
            try {
                if (currentPwd) {
                    const cred = EmailAuthProvider.credential(user.email, currentPwd);
                    await reauthenticateWithCredential(user, cred);
                }
                await updatePassword(user, newPwd);
                setSecurityFeedback("Mot de passe mis √† jour avec succ√®s.");
                // Efface les champs
                ['current-password','new-password','confirm-password'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
            } catch (e) {
                console.error(e);
                if (e?.code === 'auth/requires-recent-login') {
                    setSecurityFeedback("Action sensible: veuillez vous reconnecter puis r√©essayer.", false);
                } else {
                    setSecurityFeedback("√âchec de la mise √† jour du mot de passe.", false);
                }
            }
        });
    }
});

// Gestion du bouton de t√©l√©chargement des donn√©es
document.addEventListener('DOMContentLoaded', () => {
    const downloadBtn = document.getElementById('download-user-data-btn');
    if (downloadBtn) {
        downloadBtn.addEventListener('click', () => {
            const uidInput = document.getElementById('admin-uid');
            const uid = uidInput?.value.trim();
            
            if (!uid) {
                showAdminFeedback('Veuillez entrer un UID utilisateur', false);
                return;
            }
            
            showAdminFeedback('T√©l√©chargement en cours...');
            
            // Simulation - √Ä remplacer par une vraie requ√™te API
            setTimeout(() => {
                showAdminFeedback(`Donn√©es de l'utilisateur ${uid} t√©l√©charg√©es avec succ√®s !`);
            }, 2000);
        });
    }
});

// Initialisation de Firebase
if (window._cyfFirebase) {
    ({ auth, db } = window._cyfFirebase);
    initAuth();
} else {
    import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js").then(({ initializeApp }) => {
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        window._cyfFirebase = { app, auth, db };
        initAuth();
    });
}

// Gestion du menu utilisateur (idempotent)
window.addEventListener("DOMContentLoaded", () => { 
  try { updateGlobalAvatar(); } catch (e) {} 
  try { initUserMenu(); } catch (e) {} 
  try {
    if (window.VANTA && window.VANTA.BIRDS) {
      window.VANTA.BIRDS({
        el: '#vanta-birds-bg',
        mouseControls: true,
        touchControls: true,
        gyroControls: false,
        minHeight: 200.0,
        minWidth: 200.0,
        scale: 1.0,
        scaleMobile: 1.0,
        quantity: 4.0,
        backgroundColor: 0x07192f
      });
    }
  } catch (e) { console.log('Vanta init error:', e); }
});

// ----- Pr√©f√©rences (th√®me/animations/notifications) -----
async function initSettingsToggles(uid) {
    try {
        const ref = doc(db, 'users', uid);
        const snap = await getDoc(ref);
        const prefs = (snap.exists() && snap.data().prefs) || {};
        // Defaults
        const theme = (prefs.theme || localStorage.getItem('theme') || 'dark');
        const animations = (prefs.animEnabled !== false); // default true
        const weeklyEmails = (prefs.weeklyEmails === true); // default false
        const dailyReminders = (prefs.dailyReminders === true); // default false

        // Reflect UI
        const themeCk = document.getElementById('dark-theme');
        const animCk = document.getElementById('animations');
        const dailyCk = document.getElementById('daily-reminders');
        const emailCk = document.getElementById('email-notifications');
        if (themeCk) themeCk.checked = (theme !== 'light'); // checked = dark
        if (animCk) animCk.checked = animations;
        if (dailyCk) dailyCk.checked = dailyReminders;
        if (emailCk) emailCk.checked = weeklyEmails;

        // Apply theme immediately
        applyTheme(theme);
        // Persist normalized theme into localStorage for consistency across pages
        localStorage.setItem('theme', theme);

        // Wire events
        if (themeCk) themeCk.addEventListener('change', async () => {
            const newTheme = themeCk.checked ? 'dark' : 'light';
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
            try { await setDoc(ref, { prefs: { theme: newTheme } }, { merge: true }); } catch(e) { console.warn('save theme failed', e); }
        });
        if (animCk) animCk.addEventListener('change', async () => {
            const val = !!animCk.checked;
            try { await setDoc(ref, { prefs: { animEnabled: val } }, { merge: true }); } catch(e) {}
        });
        if (dailyCk) dailyCk.addEventListener('change', async () => {
            const val = !!dailyCk.checked;
            try { await setDoc(ref, { prefs: { dailyReminders: val } }, { merge: true }); } catch(e) {}
        });
        if (emailCk) emailCk.addEventListener('change', async () => {
            const val = !!emailCk.checked;
            try { await setDoc(ref, { prefs: { weeklyEmails: val } }, { merge: true }); } catch(e) {}
        });
    } catch (e) {
        console.warn('initSettingsToggles failed', e);
    }
}

function applyTheme(theme) {
    try {
        if (theme === 'light') document.body.classList.add('light-mode');
        else document.body.classList.remove('light-mode');
    } catch(e) { /* ignore */ }
}

// ----- Danger Zone: suppression du compte -----
document.addEventListener('DOMContentLoaded', () => {
    const delBtn = document.getElementById('delete-account-btn');
    if (!delBtn) return;
    delBtn.addEventListener('click', async () => {
        const user = auth && auth.currentUser;
        if (!user) return;
        if (!window.confirm('Voulez-vous vraiment supprimer votre compte ? Cette action est irr√©versible.')) return;
        const confirm2 = window.prompt('Tapez "SUPPRIMER" pour confirmer');
        if ((confirm2 || '').toUpperCase() !== 'SUPPRIMER') return;
        delBtn.disabled = true;
        try {
            try { await deleteDoc(doc(db, 'users', user.uid)); } catch(_) {}
            try { await deleteDoc(doc(db, 'roles', user.uid)); } catch(_) {}
            try {
                await deleteUser(user);
            } catch (e) {
                if (e?.code === 'auth/requires-recent-login') {
                    // reauth by provider
                    const providers = (user.providerData || []).map(p => p.providerId);
                    if (providers.includes('google.com')) {
                        await reauthenticateWithPopup(user, new GoogleAuthProvider());
                    } else if (providers.includes('github.com')) {
                        await reauthenticateWithPopup(user, new GithubAuthProvider());
                    } else if (providers.includes('password')) {
                        const pwd = window.prompt('Veuillez entrer votre mot de passe pour confirmer:');
                        if (!pwd) throw new Error('cancelled');
                        const cred = EmailAuthProvider.credential(user.email, pwd);
                        await reauthenticateWithCredential(user, cred);
                    } else {
                        throw e;
                    }
                    await deleteUser(user);
                } else { throw e; }
            }
            try { localStorage.removeItem('userAvatarUrl'); } catch(_) {}
            window.location.href = '/signup';
        } catch (err) {
            console.error('delete account failed', err);
            alert('√âchec de la suppression du compte. R√©essayez plus tard.');
            delBtn.disabled = false;
        }
    });
});

// ----- Admin helpers -----
let ADMIN_FILTER_DAYS = 7;
async function updateAdminStats() {
    try {
        const usersColl = collection(db, 'users');
        const total = await getCountFromServer(usersColl);
        const totalEl = document.getElementById('admin-users');
        if (totalEl) totalEl.textContent = String(total.data().count || 0);
        // actifs selon filtre
        const start = new Date(Date.now() - ADMIN_FILTER_DAYS*24*60*60*1000);
        const q = query(usersColl, where('lastActive', '>=', start));
        const active = await getCountFromServer(q);
        const activeEl = document.getElementById('admin-active');
        if (activeEl) activeEl.textContent = String(active.data().count || 0);
    } catch (e) { console.warn('updateAdminStats failed', e); }
}

function bindAdminHandlers() {
    // Filtres p√©riode
    document.querySelectorAll('[data-admin-range]').forEach(btn => {
        btn.addEventListener('click', async () => {
            const days = parseInt(btn.getAttribute('data-admin-range') || '7', 10);
            ADMIN_FILTER_DAYS = days;
            document.querySelectorAll('[data-admin-range]').forEach(b => b.classList.remove('btn-primary'));
            btn.classList.add('btn-primary');
            try { await updateAdminStats(); } catch(e) {}
        });
    });

    // Recherche
    const searchBtn = document.getElementById('search-user-btn');
    const searchInput = document.getElementById('search-user');
    const resultsEl = document.getElementById('admin-search-results');
    if (searchBtn && searchInput && resultsEl) {
        searchBtn.addEventListener('click', async () => {
            const term = (searchInput.value || '').trim();
            if (!term) return;
            resultsEl.textContent = 'Recherche...';
            try {
                const usersColl = collection(db, 'users');
                let docsRes = [];
                if (term.includes('@')) {
                    const q1 = query(usersColl, where('email', '==', term), limit(10));
                    docsRes = (await getDocs(q1)).docs;
                } else {
                    const end = term + '\\uf8ff';
                    const q2 = query(usersColl, where('displayName', '>=', term), where('displayName', '<=', end), limit(10));
                    docsRes = (await getDocs(q2)).docs;
                }
                if (!docsRes.length) { resultsEl.textContent = 'Aucun r√©sultat.'; return; }
                resultsEl.innerHTML = docsRes.map(d => { const u=d.data()||{}; const uid=d.id; return `<div data-user-uid="${uid}" class="admin-user-row" style="padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.06);cursor:pointer"><strong>${u.displayName || '(sans nom)'} </strong><span style=\"color:#6b7280\">${u.email || ''}</span><br><small>UID: ${uid}</small></div>`; }).join('');
                // open detail modal
                resultsEl.querySelectorAll('.admin-user-row').forEach(row => {
                    row.addEventListener('click', () => {
                        const uid = row.getAttribute('data-user-uid');
                        openUserDetailModal(uid);
                    });
                });
            } catch (e) { resultsEl.textContent = 'Erreur de recherche.'; }
        });
    }
    // Export CSV
    const exportBtn = document.getElementById('export-csv-btn');
    if (exportBtn) {
        exportBtn.addEventListener('click', async () => {
            try {
                const usersColl = collection(db, 'users');
                const start = new Date(Date.now() - ADMIN_FILTER_DAYS*24*60*60*1000);
                const q = query(usersColl, where('lastActive', '>=', start));
                const snap = await getDocs(q);
                const rows = [];
                rows.push(['uid','email','displayName','lastActive','lvl_body','lvl_etre','lvl_heart','lvl_order','badgesCount']);
                snap.forEach(d => {
                    const u = d.data() || {};
                    const lv = (u.levels || {});
                    const lvn = { body: lv.body?.level || 0, etre: (lv.etre?.level || (lv.mind?.level || 0)), heart: lv.heart?.level || 0, order: lv.order?.level || 0 };
                    const last = u.lastActive?.toDate ? u.lastActive.toDate() : (u.lastActive || null);
                    const lastIso = last ? new Date(last).toISOString() : '';
                    const badgesCount = Array.isArray(u.badges) ? u.badges.length : 0;
                    rows.push([d.id, u.email||'', u.displayName||'', lastIso, lvn.body, lvn.etre, lvn.heart, lvn.order, badgesCount]);
                });
                const csv = rows.map(r => r.map(x => String(x).replaceAll('"','""')).map(x => `"${x}"`).join(',')).join('\r\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `users_${ADMIN_FILTER_DAYS}j.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                showAdminFeedback('CSV export√©.');
            } catch (e) { showAdminFeedback('√âchec export CSV', false); }
        });
    }
    // Mod√©ration

// Modal helpers
function ensureModalRoot() {
    let el = document.getElementById('admin-modal-root');
    if (!el) {
        el = document.createElement('div');
        el.id = 'admin-modal-root';
        el.style.position = 'fixed'; el.style.inset = '0'; el.style.display = 'none'; el.style.alignItems = 'center'; el.style.justifyContent = 'center'; el.style.background = 'rgba(0,0,0,0.5)'; el.style.zIndex = '99999';
        el.innerHTML = `<div id="admin-modal" style="max-width:640px;width:92%;background:rgba(31,41,55,0.95);border:1px solid rgba(255,255,255,0.15);border-radius:12px;padding:18px;color:#e5eef8">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><h3>D√©tail utilisateur</h3><button id="admin-modal-close" class="btn btn-secondary">Fermer</button></div>
            <div id="admin-modal-content" style="max-height:60vh;overflow:auto"></div>
        </div>`;
        document.body.appendChild(el);
        el.addEventListener('click', (e) => { if (e.target === el) el.style.display='none'; });
        el.querySelector('#admin-modal-close').addEventListener('click', ()=> { el.style.display='none'; });
    }
    return el;
}

async function openUserDetailModal(uid) {
    const root = ensureModalRoot();
    const content = root.querySelector('#admin-modal-content');
    content.innerHTML = '<div class="note">Chargement...</div>';
    root.style.display = 'flex';
    try {
        const uref = doc(db,'users',uid);
        const rref = doc(db,'roles',uid);
        const [usnap, rsnap] = await Promise.all([getDoc(uref), getDoc(rref)]);
        const u = usnap.exists() ? usnap.data() : {};
        const isMod = rsnap.exists() && rsnap.data().mod === true;
        const lv = u.levels || {};
        const lvn = { body: lv.body?.level || 0, etre: (lv.etre?.level || (lv.mind?.level || 0)), heart: lv.heart?.level || 0, order: lv.order?.level || 0 };
        const badges = Array.isArray(u.badges) ? u.badges : [];
        content.innerHTML = `
            <div class="grid-2">
                <div>
                    <div class="input-group"><div class="input-label">Nom</div><div>${u.displayName||'(sans nom)'}</div></div>
                    <div class="input-group"><div class="input-label">Email</div><div>${u.email||''}</div></div>
                    <div class="input-group"><div class="input-label">UID</div><div><code>${uid}</code></div></div>
                </div>
                <div>
                    <div class="input-group"><div class="input-label">R√¥le Mod√©rateur</div>
                        <button id="toggle-mod" class="btn ${isMod? 'btn-secondary':'btn-primary'}">${isMod?'Retirer Mod√©rateur':'Ajouter Mod√©rateur'}</button>
                    </div>
                    <div class="note">Les admins restent g√©r√©s via la constante c√¥t√© client pour le moment.</div>
                </div>
            </div>
            <div class="settings-group" style="margin-top:12px">
                <h3 class="settings-group-title">Niveaux</h3>
                <div class="grid-2">
                    <div>Corps: <strong>${lvn.body}</strong></div>
                    <div>√ätre: <strong>${lvn.etre}</strong></div>
                    <div>C≈ìur: <strong>${lvn.heart}</strong></div>
                    <div>Ordre: <strong>${lvn.order}</strong></div>
                </div>
            </div>
            <div class="settings-group">
                <h3 class="settings-group-title">Badges (${badges.length})</h3>
                <div style="display:flex;flex-wrap:wrap;gap:8px;">${badges.map(b => `<span class="pill">${b}</span>`).join('') || '<span class="subtle">Aucun badge</span>'}</div>
            </div>
        `;
        const btn = root.querySelector('#toggle-mod');
        if (btn) {
            btn.addEventListener('click', async () => {
                try { await setDoc(doc(db,'roles',uid), { mod: !isMod }, { merge: true }); showAdminFeedback(!isMod? 'Mod ajout√©' : 'Mod retir√©'); root.style.display = 'none'; }
                catch (e) { showAdminFeedback('Action r√¥le √©chou√©e', false); }
            });
        }
    } catch (e) {
        content.innerHTML = '<div class="note">Erreur de chargement.</div>';
    }
}
    const addBtn = document.getElementById('add-mod-btn');
    const remBtn = document.getElementById('remove-mod-btn');
    const uidInput = document.getElementById('mod-uid');
    const fb = document.getElementById('admin-roles-feedback');
    function setFB(msg, ok=true){ if(!fb) return; fb.style.display='block'; fb.textContent=msg; fb.style.background= ok? 'rgba(16,185,129,0.12)':'rgba(239,68,68,0.12)'; fb.style.border= ok? '1px solid rgba(16,185,129,0.35)':'1px solid rgba(239,68,68,0.35)'; fb.style.color= ok? '#10b981':'#ef4444'; setTimeout(()=>{fb.style.display='none';},3500); }
    if (addBtn && uidInput) addBtn.addEventListener('click', async () => { const target=(uidInput.value||'').trim(); if(!target) return; try { await setDoc(doc(db,'roles',target), { mod: true }, { merge: true }); setFB('Mod√©rateur ajout√©.'); } catch(e){ setFB('√âchec ajout mod√©rateur', false); } });
    if (remBtn && uidInput) remBtn.addEventListener('click', async () => { const target=(uidInput.value||'').trim(); if(!target) return; try { await setDoc(doc(db,'roles',target), { mod: false }, { merge: true }); setFB('Mod√©rateur retir√©.'); } catch(e){ setFB('√âchec retrait mod√©rateur', false); } });
}
</script>
</body>
</html>
